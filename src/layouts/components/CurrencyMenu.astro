---
interface Props { context?: "bar" | "header" }
const { context = "header" } = Astro.props;

function getSaved() {
  try { return localStorage.getItem('currency') || 'USD'; } catch { return 'USD'; }
}

function readAndApply(el: HTMLSelectElement | null) {
  if (!el) return;
  const currency = el.value;
  try { localStorage.setItem("currency", currency); } catch {}
  try { window.dispatchEvent(new CustomEvent("currencychange", { detail: currency })); } catch {}
  fetch("/api/cart-currency", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ currency }),
  }).catch(() => {}).finally(() => location.reload());
}

function onChange(ev?: Event) {
  const el =
    (ev && ev.target && (ev.target as HTMLSelectElement)) ||
    (document.querySelector('[data-currency-select="true"]') as HTMLSelectElement | null);
  readAndApply(el);
}

const headerStyle =
  "rounded-full border px-3 py-2 text-sm hover:bg-black/5 dark:hover:bg-white/10 "+
  "bg-white/90 dark:bg-darkmode-light/90 border-border dark:border-darkmode-border "+
  "text-text-dark dark:text-darkmode-text-dark";

const barSelect =
  "appearance-none bg-transparent text-white border-0 px-2 py-1 text-[12px] sm:text-[13px] "+
  "pr-5 focus:outline-none focus:ring-2 focus:ring-white/60 cursor-pointer";
---

{context === "bar" ? (
  <div class="relative z-10">
    <select
      data-currency-select="true"
      aria-label="Moneda"
      class={barSelect}
      style="color-scheme: light"
      on:change={(e) => onChange(e)}
      client:load
    >
      <option value="USD" selected={getSaved()==='USD'}>USD $</option>
      <option value="EUR" selected={getSaved()==='EUR'}>EUR €</option>
      <option value="MXN" selected={getSaved()==='MXN'}>MXN $</option>
    </select>
    <svg class="pointer-events-none absolute right-0 top-1/2 -translate-y-1/2"
         width="12" height="12" viewBox="0 0 20 20" fill="currentColor">
      <path d="M5.8 7.5 10 11.7l4.2-4.2 1.3 1.3L10 14.3 4.5 8.8l1.3-1.3z" />
    </svg>
  </div>
) : (
  <select
    data-currency-select="true"
    aria-label="Moneda"
    class={headerStyle}
    on:change={(e) => onChange(e)}
    client:load
  >
    <option value="USD" selected={getSaved()==='USD'}>USD $</option>
    <option value="EUR" selected={getSaved()==='EUR'}>EUR €</option>
    <option value="MXN" selected={getSaved()==='MXN'}>MXN $</option>
  </select>
)}
